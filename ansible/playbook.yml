---
- name: Wait for instances to be ready and verify setup
  hosts: all
  become: yes
  gather_facts: no

  tasks:
    - name: Wait for SSH connection
      wait_for_connection:
        timeout: 300

    - name: Check if cloud-init completed
      shell: |
        if [ -f /var/lib/cloud/instance/boot-finished ]; then
          echo "cloud-init already completed"
        else
          echo "cloud-init not completed, waiting..."
          sleep 30
        fi
      changed_when: false
      register: cloud_init_check

    - name: Wait additional time if needed
      pause:
        seconds: 30
      when: "'already' not in cloud_init_check.stdout"

    - name: Verify Docker installation
      shell: |
        docker --version
        systemctl is-active docker
      register: docker_check
      changed_when: false

    - name: Verify Kubernetes installation
      shell: |
        kubeadm version -o short 2>/dev/null || echo "kubeadm not installed"
        kubelet --version 2>/dev/null || echo "kubelet not installed"
      register: kube_check
      changed_when: false

    - name: Debug show installation status
      debug:
        msg:
          - "Docker: {{ docker_check.stdout_lines }}"
          - "Kubernetes: {{ kube_check.stdout_lines }}"

- name: Configure and verify Kubernetes Master
  hosts: master
  become: yes

  tasks:
    - name: Check if kubeconfig exists
      stat:
        path: /etc/kubernetes/admin.conf
      register: kubeconfig

    - name: Initialize cluster if not already done
      shell: |
        kubeadm init --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors=all
      when: not kubeconfig.stat.exists

    - name: Setup kubeconfig for root
      shell: |
        mkdir -p /root/.kube
        cp -i /etc/kubernetes/admin.conf /root/.kube/config
        chown $(id -u):$(id -g) /root/.kube/config
      when: not kubeconfig.stat.exists

    - name: Install Flannel if not installed
      shell: |
        kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
      when: not kubeconfig.stat.exists

    - name: Generate join command
      shell: |
        kubeadm token create --print-join-command > /join-cluster.sh
        chmod +x /join-cluster.sh
        cat /join-cluster.sh
      register: join_command
      changed_when: false

    - name: Display join command
      debug:
        msg: "Join command: {{ join_command.stdout }}"

- name: Join worker nodes to cluster
  hosts: workers
  become: yes

  tasks:
    - name: Wait for master API to be ready
      wait_for:
        host: "{{ hostvars[groups['master'][0]].ansible_host }}"
        port: 6443
        timeout: 300

    - name: Join worker to cluster
      shell: "{{ hostvars[groups['master'][0]]['join_command']['stdout'] }} --ignore-preflight-errors=all"
      async: 180
      poll: 15
      register: join_result

    - name: Check join result
      debug:
        msg: "Join result: {{ join_result }}"

- name: Final verification
  hosts: master
  become: yes

  tasks:
    - name: Get cluster nodes
      shell: |
        echo "=== Kubernetes Nodes ==="
        kubectl get nodes
        echo ""
        echo "=== Kubernetes Pods ==="
        kubectl get pods -A
        echo ""
        echo "=== Cluster Info ==="
        kubectl cluster-info
      register: cluster_info
      changed_when: false

    - name: Display cluster info
      debug:
        msg: "{{ cluster_info.stdout_lines }}"
