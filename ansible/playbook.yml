---
- name: Verify Master Setup
  hosts: master
  become: yes
  gather_facts: yes

  tasks:
    - name: Wait for cloud-init to complete
      wait_for:
        path: /var/lib/cloud/instance/boot-finished
        state: present
        timeout: 600

    - name: Check if kubeadm is installed
      shell: |
        if command -v kubeadm; then
          echo "INSTALLED"
        else
          echo "NOT_INSTALLED"
        fi
      register: kubeadm_check
      changed_when: false

    - name: Debug kubeadm status
      debug:
        msg: "kubeadm status: {{ kubeadm_check.stdout }}"

    - name: Check cluster status
      shell: |
        if [ -f /etc/kubernetes/admin.conf ]; then
          echo "CLUSTER_INITIALIZED"
        else
          echo "CLUSTER_NOT_INITIALIZED"
        fi
      register: cluster_status
      changed_when: false

    - name: Debug cluster status
      debug:
        msg: "Cluster status: {{ cluster_status.stdout }}"

    - name: Display join command if exists
      shell: cat /join-cluster.sh 2>/dev/null || echo "NO_JOIN_COMMAND"
      register: join_command
      changed_when: false

    - name: Show join command
      debug:
        msg: "Join command: {{ join_command.stdout }}"

- name: Verify Worker Setup
  hosts: workers
  become: yes
  gather_facts: yes

  tasks:
    - name: Wait for cloud-init to complete
      wait_for:
        path: /var/lib/cloud/instance/boot-finished
        state: present
        timeout: 600

    - name: Check if worker has joined
      shell: |
        if [ -f /etc/kubernetes/kubelet.conf ]; then
          echo "WORKER_JOINED"
        else
          echo "WORKER_NOT_JOINED"
        fi
      register: worker_status
      changed_when: false

    - name: Debug worker status
      debug:
        msg: "Worker status: {{ worker_status.stdout }}"

- name: Final Cluster Verification
  hosts: master
  become: yes

  tasks:
    - name: Get cluster info
      shell: |
        echo "=== KUBERNETES CLUSTER INFO ==="
        kubectl cluster-info 2>/dev/null || echo "Cluster not ready"
        echo ""
        echo "=== NODES ==="
        kubectl get nodes 2>/dev/null || echo "No nodes found"
        echo ""
        echo "=== SYSTEM PODS ==="
        kubectl get pods -n kube-system 2>/dev/null || echo "No pods found"
      register: cluster_info
      changed_when: false

    - name: Display cluster info
      debug:
        msg: "{{ cluster_info.stdout_lines }}"
