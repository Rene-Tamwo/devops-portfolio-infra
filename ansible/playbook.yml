---
- name: Diagnostic et r√©paration du cluster Kubernetes
  hosts: master
  become: yes

  tasks:
    - name: Attendre la connexion SSH
      wait_for_connection:
        timeout: 300

    - name: V√©rifier l'√©tat des services Kubernetes
      shell: |
        echo "=== √âtat des services ==="
        systemctl status kubelet --no-pager || true
        echo ""
        echo "=== Logs kubelet (derni√®res 20 lignes) ==="
        journalctl -u kubelet -n 20 --no-pager || true
        echo ""
        echo "=== Fichiers de configuration Kubernetes ==="
        ls -la /etc/kubernetes/ || true
        echo ""
        echo "=== V√©rifier si l'API server √©coute ==="
        netstat -tlnp | grep 6443 || echo "Port 6443 non √©cout√©"
      register: service_check
      changed_when: false

    - name: Afficher le diagnostic
      debug:
        msg: "{{ service_check.stdout_lines }}"

    - name: V√©rifier si le cluster est initialis√© mais cass√©
      shell: |
        if [ -f /etc/kubernetes/admin.conf ]; then
          echo "admin_conf_exists"
          # V√©rifier si les composants tournent
          if systemctl is-active kubelet >/dev/null 2>&1; then
            # Attendre un peu pour l'API server
            sleep 30
            if timeout 10 kubectl get nodes --kubeconfig=/etc/kubernetes/admin.conf 2>/dev/null; then
              echo "cluster_healthy"
            else
              echo "cluster_broken"
            fi
          else
            echo "kubelet_inactive"
          fi
        else
          echo "not_initialized"
        fi
      register: cluster_health
      changed_when: false

    - name: R√©parer le cluster si cass√©
      block:
        - name: Reset kubeadm si cluster cass√©
          shell: |
            echo "üîÑ R√©initialisation du cluster Kubernetes..."
            kubeadm reset -f
            rm -rf /etc/kubernetes/* /var/lib/etcd/* ~/.kube/*
          when: "'cluster_broken' in cluster_health.stdout or 'kubelet_inactive' in cluster_health.stdout"

        - name: Nettoyer les interfaces r√©seau
          shell: |
            ip link delete cni0 2>/dev/null || true
            ip link delete flannel.1 2>/dev/null || true

        - name: Red√©marrer kubelet
          systemd:
            name: kubelet
            state: restarted
            daemon_reload: yes

        - name: Initialiser le cluster
          shell: |
            kubeadm init --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors=all
          async: 300
          poll: 10

        - name: Configurer kubectl pour root
          shell: |
            mkdir -p /root/.kube
            cp -i /etc/kubernetes/admin.conf /root/.kube/config
            chown $(id -u):$(id -g) /root/.kube/config

        - name: Configurer kubectl pour ubuntu
          shell: |
            mkdir -p /home/ubuntu/.kube
            cp -i /etc/kubernetes/admin.conf /home/ubuntu/.kube/config
            chown -R ubuntu:ubuntu /home/ubuntu/.kube

        - name: Installer Flannel
          shell: |
            kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
          when: "'cluster_broken' in cluster_health.stdout or 'kubelet_inactive' in cluster_health.stdout or 'not_initialized' in cluster_health.stdout"
      when: "'cluster_broken' in cluster_health.stdout or 'kubelet_inactive' in cluster_health.stdout or 'not_initialized' in cluster_health.stdout"

    - name: Attendre que l'API server soit pr√™t
      wait_for:
        port: 6443
        delay: 10
        timeout: 300
      when: "'cluster_broken' in cluster_health.stdout or 'kubelet_inactive' in cluster_health.stdout or 'not_initialized' in cluster_health.stdout"

    - name: G√©n√©rer le token de join
      shell: |
        kubeadm token create --ttl 24h --print-join-command > /join-cluster.sh
        chmod +x /join-cluster.sh
        cat /join-cluster.sh
      register: join_command
      changed_when: false

    - name: Afficher le token de join
      debug:
        msg: "Token de join : {{ join_command.stdout }}"

    - name: V√©rifier l'√©tat du cluster
      shell: |
        echo "=== √âtat des n≈ìuds ==="
        kubectl get nodes -o wide 2>/dev/null || echo "Cluster non accessible"
        echo ""
        echo "=== Pods syst√®me ==="
        kubectl get pods -n kube-system -o wide 2>/dev/null || echo "Cluster non accessible"
        echo ""
        echo "=== Services ==="
        systemctl status kubelet --no-pager | grep -A5 "Active:" || true
      register: final_check
      changed_when: false

    - name: Afficher l'√©tat final
      debug:
        msg: "{{ final_check.stdout_lines }}"

- name: Configurer les workers
  hosts: workers
  become: yes
  vars:
    master_ip: "{{ hostvars[groups['master'][0]].ansible_host }}"

  tasks:
    - name: Attendre la connexion SSH
      wait_for_connection:
        timeout: 300

    - name: V√©rifier si d√©j√† joint au cluster
      shell: |
        if [ -f /etc/kubernetes/kubelet.conf ]; then
          echo "already_joined"
          # V√©rifier si kubelet tourne
          if systemctl is-active kubelet >/dev/null 2>&1; then
            echo "kubelet_active"
          else
            echo "kubelet_inactive"
          fi
        else
          echo "not_joined"
        fi
      register: worker_status
      changed_when: false

    - name: R√©parer le worker si n√©cessaire
      block:
        - name: Reset si n√©cessaire
          shell: |
            kubeadm reset -f 2>/dev/null || true
            rm -rf /etc/kubernetes/* /var/lib/etcd/* ~/.kube/*
          when: "'kubelet_inactive' in worker_status.stdout"

        - name: Red√©marrer kubelet
          systemd:
            name: kubelet
            state: restarted
            daemon_reload: yes
      when: "'kubelet_inactive' in worker_status.stdout"

    - name: Joindre le cluster si pas d√©j√† fait
      block:
        - name: Attendre que le master soit pr√™t
          wait_for:
            host: "{{ master_ip }}"
            port: 6443
            timeout: 300

        - name: R√©cup√©rer la commande join depuis le master
          shell: |
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
              ubuntu@{{ master_ip }} "cat /join-cluster.sh"
          register: join_cmd
          retries: 3
          delay: 10
          until: join_cmd.stdout != ""

        - name: Ex√©cuter la commande join
          shell: "{{ join_cmd.stdout }} --ignore-preflight-errors=all"
          async: 180
          poll: 15
          register: join_result

        - name: V√©rifier le r√©sultat
          debug:
            msg: "R√©sultat du join : {{ join_result }}"
      when: "'not_joined' in worker_status.stdout"

    - name: V√©rifier l'√©tat du worker
      shell: |
        echo "=== √âtat du worker ==="
        systemctl status kubelet --no-pager | grep -A5 "Active:" || true
        echo ""
        echo "=== Version kubelet ==="
        kubelet --version 2>/dev/null || echo "kubelet non install√©"
      register: worker_check
      changed_when: false

    - name: Afficher l'√©tat du worker
      debug:
        msg: "{{ worker_check.stdout_lines }}"

- name: V√©rification finale du cluster
  hosts: master
  become: yes

  tasks:
    - name: Attendre que tous les n≈ìuds soient pr√™ts
      shell: |
        TIMEOUT=600
        INTERVAL=10
        ELAPSED=0
        while [ $ELAPSED -lt $TIMEOUT ]; do
          READY_NODES=$(kubectl get nodes --no-headers 2>/dev/null | grep -c "Ready" || echo 0)
          TOTAL_NODES=$(({{ groups['workers'] | length }} + 1))
          if [ "$READY_NODES" -eq "$TOTAL_NODES" ]; then
            echo "‚úÖ Tous les $TOTAL_NODES n≈ìuds sont pr√™ts"
            exit 0
          fi
          echo "‚è≥ En attente... ($READY_NODES/$TOTAL_NODES n≈ìuds pr√™ts)"
          sleep $INTERVAL
          ELAPSED=$((ELAPSED + INTERVAL))
        done
        echo "‚ùå Timeout atteint"
        exit 1
      register: wait_result
      changed_when: false

    - name: Afficher l'√©tat final du cluster
      shell: |
        echo "üéâ CLUSTER KUBERNETES OP√âRATIONNEL"
        echo ""
        echo "=== N≈íUDS ==="
        kubectl get nodes -o wide
        echo ""
        echo "=== PODS (tous les namespaces) ==="
        kubectl get pods --all-namespaces -o wide
        echo ""
        echo "=== SERVICES ==="
        kubectl get svc --all-namespaces
        echo ""
        echo "=== R√âSUM√â ==="
        echo "Master: {{ hostvars[groups['master'][0]].ansible_host }}"
        echo "Workers: {{ groups['workers'] | map('extract', hostvars, 'ansible_host') | list }}"
      register: cluster_summary
      changed_when: false

    - name: Afficher le r√©sum√©
      debug:
        msg: "{{ cluster_summary.stdout_lines }}"

    - name: Sauvegarder le kubeconfig localement
      fetch:
        src: /etc/kubernetes/admin.conf
        dest: "./kubeconfig-{{ cluster_name }}.conf"
        flat: yes
      register: kubeconfig_fetch

    - name: Afficher le chemin du kubeconfig
      debug:
        msg: "Kubeconfig sauvegard√© : {{ kubeconfig_fetch.dest }}"
