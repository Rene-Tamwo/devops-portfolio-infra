---
- name: Wait for all nodes to be fully ready
  hosts: all
  become: yes
  gather_facts: no

  tasks:
    - name: Wait for SSH connection
      wait_for_connection:
        timeout: 300

    - name: Wait for cloud-init to complete
      shell: |
        # Attendre que cloud-init termine
        while [ ! -f /var/lib/cloud/instance/boot-finished ]; do
          echo "Waiting for cloud-init..."
          sleep 10
        done
        echo "cloud-init completed"
      register: cloud_init_wait
      changed_when: false

    - name: Wait for Docker installation
      shell: |
        # Attendre que Docker soit installé et démarré
        for i in {1..30}; do
          if systemctl is-active --quiet docker; then
            echo "Docker is running"
            exit 0
          fi
          echo "Waiting for Docker... ($i/30)"
          sleep 10
        done
        echo "Docker not ready after 5 minutes"
        exit 1
      register: docker_wait
      changed_when: false

    - name: Check if kubeadm is installed
      shell: |
        # Vérifier si kubeadm est installé
        if command -v kubeadm >/dev/null 2>&1; then
          echo "kubeadm is installed"
          exit 0
        else
          echo "kubeadm not found, trying to install..."
          # Tenter d'installer kubeadm si manquant
          apt-get update
          apt-get install -y apt-transport-https curl
          curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
          echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" | tee /etc/apt/sources.list.d/kubernetes.list
          apt-get update
          apt-get install -y kubelet kubeadm kubectl
          apt-mark hold kubelet kubeadm kubectl
          echo "kubeadm installed"
          exit 0
        fi
      register: kubeadm_check
      changed_when: false

- name: Configure Master Node
  hosts: master
  become: yes

  tasks:
    - name: Initialize Kubernetes cluster if not already done
      shell: |
        # Vérifier si le cluster est déjà initialisé
        if [ -f /etc/kubernetes/admin.conf ]; then
          echo "Cluster already initialized"
          exit 0
        fi
        
        # Initialiser le cluster
        kubeadm init --pod-network-cidr=10.244.0.0/16 \
          --apiserver-advertise-address=$(hostname -I | awk '{print $1}') \
          --ignore-preflight-errors=all
        
        # Configurer kubectl
        mkdir -p /root/.kube
        cp -i /etc/kubernetes/admin.conf /root/.kube/config
        chown $(id -u):$(id -g) /root/.kube/config
        
        # Installer Flannel
        kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
        
        # Créer le token pour joindre les workers
        kubeadm token create --print-join-command > /join-cluster.sh
        chmod +x /join-cluster.sh
        
        echo "Cluster initialized successfully"
      register: init_cluster
      changed_when: "'Cluster initialized successfully' in init_cluster.stdout"

    - name: Wait for Kubernetes API to be ready
      shell: |
        for i in {1..30}; do
          if timeout 5 kubectl get nodes 2>/dev/null; then
            echo "Kubernetes API is ready"
            exit 0
          fi
          echo "Waiting for Kubernetes API... ($i/30)"
          sleep 10
        done
        echo "Kubernetes API not ready after 5 minutes"
        exit 1
      register: api_wait
      changed_when: false

    - name: Get join command
      shell: cat /join-cluster.sh
      register: join_command
      changed_when: false

    - name: Display join command
      debug:
        msg: "Join command: {{ join_command.stdout }}"

- name: Configure Worker Nodes
  hosts: workers
  become: yes
  vars:
    join_command: "{{ hostvars[groups['master'][0]]['join_command']['stdout'] }}"

  tasks:
    - name: Wait for master to be ready
      wait_for:
        host: "{{ hostvars[groups['master'][0]]['ansible_host'] }}"
        port: 6443
        timeout: 600
        delay: 10

    - name: Join worker to cluster
      shell: "{{ join_command }} --ignore-preflight-errors=all"
      async: 300
      poll: 10
      register: join_result

    - name: Check join result
      async_status:
        jid: "{{ join_result.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 30
      delay: 10

- name: Verify Cluster Status
  hosts: master
  become: yes

  tasks:
    - name: Get cluster nodes
      shell: kubectl get nodes -o wide
      register: nodes_status
      changed_when: false

    - name: Display nodes status
      debug:
        msg: "{{ nodes_status.stdout_lines }}"

    - name: Get all pods
      shell: kubectl get pods --all-namespaces
      register: pods_status
      changed_when: false

    - name: Display pods status
      debug:
        msg: "{{ pods_status.stdout_lines }}"

    - name: Check cluster health
      shell: |
        echo "=== Cluster Info ==="
        kubectl cluster-info
        echo ""
        echo "=== Component Status ==="
        kubectl get cs
        echo ""
        echo "=== Node Details ==="
        kubectl describe nodes
      register: cluster_health
      changed_when: false

    - name: Save kubeconfig
      fetch:
        src: /root/.kube/config
        dest: kubeconfig.yaml
        flat: yes
      changed_when: false
