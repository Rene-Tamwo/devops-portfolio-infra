---
- name: Wait for nodes to be ready and join cluster
  hosts: all
  become: yes
  gather_facts: no

  tasks:
    - name: Check if Kubernetes is installed
      shell: which kubeadm
      register: kubeadm_check
      changed_when: false

- name: Configure Master Node
  hosts: master
  become: yes

  tasks:
    - name: Wait for Kubernetes API
      shell: |
        for i in {1..30}; do
          if kubectl get nodes 2>/dev/null; then
            echo "Kubernetes API ready"
            exit 0
          fi
          echo "Waiting for API... ($i/30)"
          sleep 10
        done
        exit 1
      register: api_wait
      changed_when: false

    - name: Get join command from master
      shell: cat /join-cluster.sh
      register: join_command
      changed_when: false

    - name: Display join command
      debug:
        msg: "Join command: {{ join_command.stdout }}"

- name: Join Worker Nodes
  hosts: workers
  become: yes
  vars:
    join_command: "{{ hostvars[groups['master'][0]]['join_command']['stdout'] }}"

  tasks:
    - name: Wait for master API to be accessible
      wait_for:
        host: "{{ hostvars[groups['master'][0]]['ansible_host'] }}"
        port: 6443
        timeout: 300
        delay: 10

    - name: Join worker to cluster
      shell: "{{ join_command }} --ignore-preflight-errors=all"

- name: Verify Cluster
  hosts: master
  become: yes

  tasks:
    - name: Check cluster status
      shell: |
        echo "=== Nodes ==="
        kubectl get nodes -o wide
        echo ""
        echo "=== Pods ==="
        kubectl get pods --all-namespaces
      register: cluster_status
      changed_when: false

    - name: Display cluster status
      debug:
        msg: "{{ cluster_status.stdout_lines }}"
