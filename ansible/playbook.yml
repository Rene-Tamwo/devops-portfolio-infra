---
- name: Diagnose and repair Kubernetes cluster
  hosts: master
  become: yes

  tasks:
    - name: Wait for SSH connection
      wait_for_connection:
        timeout: 300

    - name: Check Kubernetes services status
      shell: |
        echo "=== Service status ==="
        systemctl status kubelet --no-pager || true
        echo ""
        echo "=== Kubernetes config files ==="
        ls -la /etc/kubernetes/ || true
        echo ""
        echo "=== Check port 6443 ==="
        netstat -tlnp | grep 6443 || echo "Port 6443 not listening"
      register: service_check
      changed_when: false

    - name: Display diagnostic info
      debug:
        msg: "{{ service_check.stdout_lines }}"

    - name: Check if cluster is initialized
      shell: |
        if [ -f /etc/kubernetes/admin.conf ]; then
          echo "admin_conf_exists"
          if systemctl is-active kubelet >/dev/null 2>&1; then
            sleep 30
            if timeout 10 kubectl get nodes --kubeconfig=/etc/kubernetes/admin.conf 2>/dev/null; then
              echo "cluster_healthy"
            else
              echo "cluster_broken"
            fi
          else
            echo "kubelet_inactive"
          fi
        else
          echo "not_initialized"
        fi
      register: cluster_health
      changed_when: false

    - name: Repair broken cluster if needed
      block:
        - name: Reset kubeadm if cluster broken
          shell: |
            echo "Resetting Kubernetes cluster..."
            kubeadm reset -f
            rm -rf /etc/kubernetes/* /var/lib/etcd/* ~/.kube/*
          when: "'cluster_broken' in cluster_health.stdout or 'kubelet_inactive' in cluster_health.stdout"

        - name: Clean network interfaces
          shell: |
            ip link delete cni0 2>/dev/null || true
            ip link delete flannel.1 2>/dev/null || true

        - name: Restart kubelet
          systemd:
            name: kubelet
            state: restarted
            daemon_reload: yes

        - name: Initialize cluster
          shell: |
            kubeadm init --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors=all
          async: 300
          poll: 10

        - name: Configure kubectl for root
          shell: |
            mkdir -p /root/.kube
            cp -i /etc/kubernetes/admin.conf /root/.kube/config
            chown $(id -u):$(id -g) /root/.kube/config

        - name: Configure kubectl for ubuntu user
          shell: |
            mkdir -p /home/ubuntu/.kube
            cp -i /etc/kubernetes/admin.conf /home/ubuntu/.kube/config
            chown -R ubuntu:ubuntu /home/ubuntu/.kube

        - name: Install Flannel network plugin
          shell: |
            kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
      when: "'cluster_broken' in cluster_health.stdout or 'kubelet_inactive' in cluster_health.stdout or 'not_initialized' in cluster_health.stdout"

    - name: Wait for API server to be ready
      wait_for:
        port: 6443
        delay: 10
        timeout: 300

    - name: Generate join token
      shell: |
        kubeadm token create --ttl 24h --print-join-command > /join-cluster.sh
        chmod +x /join-cluster.sh
        cat /join-cluster.sh
      register: join_command
      changed_when: false

    - name: Display join command
      debug:
        msg: "Join command: {{ join_command.stdout }}"

    - name: Check cluster state
      shell: |
        echo "=== Nodes ==="
        kubectl get nodes -o wide 2>/dev/null || echo "Cluster not accessible"
        echo ""
        echo "=== System pods ==="
        kubectl get pods -n kube-system -o wide 2>/dev/null || echo "Cluster not accessible"
      register: final_check
      changed_when: false

    - name: Display final state
      debug:
        msg: "{{ final_check.stdout_lines }}"

- name: Configure worker nodes
  hosts: workers
  become: yes

  tasks:
    - name: Wait for SSH connection
      wait_for_connection:
        timeout: 300

    - name: Check if already joined to cluster
      shell: |
        if [ -f /etc/kubernetes/kubelet.conf ]; then
          echo "already_joined"
          if systemctl is-active kubelet >/dev/null 2>&1; then
            echo "kubelet_active"
          else
            echo "kubelet_inactive"
          fi
        else
          echo "not_joined"
        fi
      register: worker_status
      changed_when: false

    - name: Repair worker if needed
      block:
        - name: Reset if needed
          shell: |
            kubeadm reset -f 2>/dev/null || true
            rm -rf /etc/kubernetes/* /var/lib/etcd/* ~/.kube/*
          when: "'kubelet_inactive' in worker_status.stdout"

        - name: Restart kubelet
          systemd:
            name: kubelet
            state: restarted
            daemon_reload: yes
      when: "'kubelet_inactive' in worker_status.stdout"

    - name: Get master IP
      set_fact:
        master_ip: "{{ hostvars[groups['master'][0]].ansible_host }}"

    - name: Join cluster if not already joined
      block:
        - name: Wait for master to be ready
          wait_for:
            host: "{{ master_ip }}"
            port: 6443
            timeout: 300

        - name: Get join command from master
          shell: |
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
              ubuntu@{{ master_ip }} "cat /join-cluster.sh"
          register: join_cmd
          retries: 3
          delay: 10

        - name: Execute join command
          shell: "{{ join_cmd.stdout }} --ignore-preflight-errors=all"
          async: 180
          poll: 15
          register: join_result

        - name: Check join result
          debug:
            msg: "Join result: {{ join_result }}"
      when: "'not_joined' in worker_status.stdout"

    - name: Check worker state
      shell: |
        echo "=== Worker state ==="
        systemctl status kubelet --no-pager | grep -A5 "Active:" || true
        echo ""
        echo "=== Kubelet version ==="
        kubelet --version 2>/dev/null || echo "kubelet not installed"
      register: worker_check
      changed_when: false

    - name: Display worker state
      debug:
        msg: "{{ worker_check.stdout_lines }}"

- name: Final cluster verification
  hosts: master
  become: yes

  tasks:
    - name: Wait for all nodes to be ready
      shell: |
        TIMEOUT=600
        INTERVAL=10
        ELAPSED=0
        while [ $ELAPSED -lt $TIMEOUT ]; do
          READY_NODES=$(kubectl get nodes --no-headers 2>/dev/null | grep -c "Ready" || echo 0)
          TOTAL_NODES=$(({{ groups['workers'] | length }} + 1))
          if [ "$READY_NODES" -eq "$TOTAL_NODES" ]; then
            echo "All $TOTAL_NODES nodes are ready"
            exit 0
          fi
          echo "Waiting... ($READY_NODES/$TOTAL_NODES nodes ready)"
          sleep $INTERVAL
          ELAPSED=$((ELAPSED + INTERVAL))
        done
        echo "Timeout reached"
        exit 1
      register: wait_result
      changed_when: false

    - name: Display final cluster status
      shell: |
        echo "KUBERNETES CLUSTER OPERATIONAL"
        echo ""
        echo "=== NODES ==="
        kubectl get nodes -o wide
        echo ""
        echo "=== PODS (all namespaces) ==="
        kubectl get pods --all-namespaces -o wide
        echo ""
        echo "=== SERVICES ==="
        kubectl get svc --all-namespaces
        echo ""
        echo "=== SUMMARY ==="
        echo "Master: {{ hostvars[groups['master'][0]].ansible_host }}"
        echo "Workers: {{ groups['workers'] | map('extract', hostvars, 'ansible_host') | list }}"
      register: cluster_summary
      changed_when: false

    - name: Display summary
      debug:
        msg: "{{ cluster_summary.stdout_lines }}"
